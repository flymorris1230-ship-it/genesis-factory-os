# Sprint 1 Day 2 Journal

**日期**: 2025-10-06
**主題**: Supabase Auth 整合與認證系統
**狀態**: ✅ 完成

## 今日成果

### Supabase Auth 整合
- ✅ 創建 `src/lib/auth.ts` 認證輔助函數
  - 支持 Server Components 的 Supabase Client
  - 獲取當前用戶 Session
  - 整合 Factory OS User 與 Supabase User
- ✅ 更新 `src/server/trpc.ts` 整合 Supabase Auth
  - 從 Request header 提取 Authorization token
  - 驗證 Supabase User
  - 獲取完整的 Factory OS 用戶資訊（租戶、角色）
  - 創建 `protectedProcedure` 中間件

### UI 組件
- ✅ 創建 shadcn/ui 基礎組件
  - Button (`src/components/ui/button.tsx`)
  - Input (`src/components/ui/input.tsx`)
  - Label (`src/components/ui/label.tsx`)
  - Card (`src/components/ui/card.tsx`)

### 認證頁面
- ✅ 登入頁面 (`src/app/(auth)/login/page.tsx`)
  - 使用 `LoginForm` 組件
  - Email/密碼登入
  - 錯誤處理
  - 登入成功後重定向到 Dashboard
- ✅ 註冊頁面 (`src/app/(auth)/register/page.tsx`)
  - 使用 `RegisterForm` 組件
  - 密碼確認驗證
  - Email 驗證流程
  - 註冊成功提示
- ✅ Auth Callback (`src/app/(auth)/auth/callback/route.ts`)
  - 處理 Email 驗證後的回調
  - 交換 Code 為 Session

### Dashboard 頁面
- ✅ 受保護的 Dashboard (`src/app/(dashboard)/dashboard/page.tsx`)
  - 檢查用戶認證狀態
  - 顯示用戶資訊
  - 顯示租戶資訊
  - 展示系統模組（WMS, MES, QMS, R&D）
  - 登出功能
- ✅ 登出 API (`src/app/api/auth/signout/route.ts`)

### Middleware
- ✅ Next.js Middleware (`src/middleware.ts`)
  - 保護 `/dashboard` 路由
  - 未登入用戶重定向到登入頁
  - 已登入用戶訪問登入/註冊頁重定向到 Dashboard

### 首頁更新
- ✅ 更新首頁 (`src/app/page.tsx`)
  - 展示系統功能介紹
  - 登入/註冊按鈕

## 測試結果

### 構建測試
```bash
npm run build
```
✅ 構建成功
- 9 個路由正確生成
- 靜態路由優化完成
- Middleware 正確編譯 (69.1 kB)

### 路由結構
```
Route (app)                              Size     First Load JS
├ ○ /                                    9.26 kB         109 kB
├ ○ /_not-found                          896 B           101 kB
├ ƒ /api/auth/signout                    149 B           100 kB
├ ƒ /api/trpc/[trpc]                     149 B           100 kB
├ ƒ /auth/callback                       149 B           100 kB
├ ƒ /dashboard                           149 B           100 kB
├ ○ /login                               1.87 kB         148 kB
└ ○ /register                            2.19 kB         148 kB
```

## 技術亮點

### 1. tRPC Context 整合 Supabase Auth
```typescript
// src/server/trpc.ts
export const createContext = async (opts: FetchCreateContextFnOptions) => {
  const requestId = randomUUID()
  const authHeader = opts.req.headers.get('authorization')

  // 從 token 獲取 Supabase User
  // 從數據庫獲取 Factory OS User (含租戶資訊)

  return {
    prisma,
    user, // 完整的用戶資訊
    requestId,
    req: opts.req,
  }
}
```

### 2. Protected Procedure
```typescript
export const protectedProcedure = t.procedure.use(async ({ ctx, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: 'You must be logged in to access this resource',
    })
  }
  return next({ ctx: { ...ctx, user: ctx.user } })
})
```

### 3. Middleware 保護路由
```typescript
// src/middleware.ts
export async function middleware(req: NextRequest) {
  const supabase = createMiddlewareClient({ req, res })
  const { data: { session } } = await supabase.auth.getSession()

  // 未登入訪問 /dashboard → 重定向到 /login
  // 已登入訪問 /login → 重定向到 /dashboard
}
```

## 遇到的問題

### 問題 1: TypeScript 編譯錯誤
**問題描述**: `@typescript-eslint/no-empty-object-type` 錯誤
```
Error: An interface declaring no members is equivalent to its supertype.
```
**解決方案**: 改用 `type` 替代 `interface`
```typescript
// ❌ 錯誤
export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {}

// ✅ 正確
export type InputProps = React.InputHTMLAttributes<HTMLInputElement>
```

### 問題 2: next.config.js 警告
**問題描述**: `swcMinify` 選項不再需要
```
⚠ Invalid next.config.js options detected:
⚠     Unrecognized key(s) in object: 'swcMinify'
```
**解決方案**: Next.js 15 已內建 SWC minify，移除此選項
**經驗教訓**: 升級 Next.js 版本時需檢查配置文件

### 問題 3: Supabase Edge Runtime 警告
**問題描述**: Middleware 中使用 Node.js API
```
A Node.js API is used (process.versions) which is not supported in the Edge Runtime.
```
**影響**: 僅為警告，不影響功能
**後續處理**: 考慮使用 Supabase Edge Functions 或調整實作方式

## 檔案結構變化

### 新增檔案
```
src/
├── lib/
│   └── auth.ts                          # Supabase Auth 輔助函數
├── components/
│   ├── ui/
│   │   ├── button.tsx                   # Button 組件
│   │   ├── input.tsx                    # Input 組件
│   │   ├── label.tsx                    # Label 組件
│   │   └── card.tsx                     # Card 組件
│   └── auth/
│       ├── LoginForm.tsx                # 登入表單
│       └── RegisterForm.tsx             # 註冊表單
├── app/
│   ├── (auth)/
│   │   ├── layout.tsx                   # Auth Layout
│   │   ├── login/
│   │   │   └── page.tsx                 # 登入頁面
│   │   ├── register/
│   │   │   └── page.tsx                 # 註冊頁面
│   │   └── auth/
│   │       └── callback/
│   │           └── route.ts             # Auth Callback
│   ├── (dashboard)/
│   │   ├── layout.tsx                   # Dashboard Layout
│   │   └── dashboard/
│   │       └── page.tsx                 # Dashboard 主頁
│   └── api/
│       └── auth/
│           └── signout/
│               └── route.ts             # 登出 API
└── middleware.ts                         # Next.js Middleware
```

### 修改檔案
```
src/
├── server/
│   └── trpc.ts                          # 整合 Supabase Auth
├── app/
│   └── page.tsx                         # 更新首頁
└── next.config.js                       # 移除 swcMinify
```

## 時間統計

- Supabase Auth 整合: 40 分鐘
- UI 組件創建: 30 分鐘
- 認證頁面實作: 60 分鐘
- Dashboard 實作: 40 分鐘
- Middleware 與路由保護: 30 分鐘
- 測試與除錯: 35 分鐘
- 文檔撰寫: 25 分鐘
- **總計**: 約 4 小時

## 下一步計劃 (Sprint 1 Day 3)

### 主要目標
1. [ ] 創建用戶註冊後的初始化流程
   - Supabase Auth Trigger
   - 自動創建 Factory OS User 記錄
   - 租戶分配機制
2. [ ] 實作測試用的 tRPC Router
   - User Router (list, get, update)
   - 測試 protectedProcedure
3. [ ] 創建測試資料腳本
   - 測試用戶
   - 測試租戶
4. [ ] E2E 測試
   - 註冊流程測試
   - 登入流程測試
   - Dashboard 訪問測試

### 技術債務
1. 📝 Supabase Edge Runtime 警告處理
2. 📝 Error Boundary 實作
3. 📝 Loading States 優化
4. 📝 Toast 通知系統整合

## 備註

- 🔐 **Auth**: Supabase Auth 完整整合
  - Email/密碼登入 ✅
  - Email 驗證流程 ✅
  - Session 管理 ✅
  - Protected Routes ✅
- 🎨 **UI/UX**: shadcn/ui 組件系統就緒
- 🚀 **Deploy Ready**: 構建成功，可部署到 Vercel
- 📊 **Sprint 1 進度**: Day 2/3 ✅

---

**記錄人**: Morris Lin
**協作**: Claude Code (AI Pair Programming)
**審核**: ✅ 通過
